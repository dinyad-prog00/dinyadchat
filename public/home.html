<!DOCTYPE html>
<html class="h-100">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    
	<title>DinyadChat</title>

	
</head>
<body class="h-100">
	<div class="h-100 d-table w-100">
		<div class="align-middle  m-1 d-table-cell  text-center ">
		<h2>DinyadChat</h2>
		<h4 class="text-muted">Salle Les Fans #12554445</h4>
		<div class="card col-md-4 offset-md-4 p-2">
		<div class="input-group">
			<label class="input-group-text">Pseudo</label>
			<input type="text" name="user" id="user" class="form-control">
			
		</div><br>
		<button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#mym">Entrer</button>
		</div>
  
		</div>
	</div>
	
  <!--
	
		<h4 class="card-title">Bien dans DinyadChat</h4>
		<a href="" data-bs-target="#toh" data-bs-toggle="collapse"> <span class="badge badge-white">Aide</span></a>
		
	
	<div class="card-body collapse show" id="toh">
		<div class="menu">
			<ul>
				<li class="menu-item">Entrez votre pseudo à utiliser dans le chat</li>
				<li class="menu-item">Cliquez sur Entrer</li>
				
			</ul>
			
		</div>
	</div>


-->






<div class="modal" id="mym" aria-hidden="true">
	<div class=" modal-dialog modal-fullscreen-sm-down  modal-dialog-scrollable">
		<div class="modal-content" id="content">
			<div class="modal-header bg-info bg-gradient text-white" >
				<div class="d-flex">
					<img src="aaa.png" class="img-thumbnail rounded-circle align-self-center m-1" alt="..." width="20%">
					<div class="m-1">
						<h4 class="modal-title ">Dinyad chat</h4>
						<span class="text-muted" id="youp">Vous en tant que <em id="you"></em></span>
					</div>
					

				</div>
			
			
				
				
			<button class="btn btn-close" data-bs-dismiss="modal"></button>
			</div>
		

	
			<div class="modal-body collapse show" id="cp">

				<div class="text-center" id="deft">
					<div class="m-2 p-2 pb-0 mb-0"><h4>Discuter instantanément avec vos amis à l'aide de DinyadChat</h4></div>
					
					<img src="disc.webp" class=" mx-auto d-block" alt="..." width="70%">

					
					<h6>Vous venez d'entrer dans le chat, tapez votre message et envoyez.</h6>
					
				</div>
				<!--
				 <div class="mt-2 col-10">
				<span class="fw-bold">Dinyad Yeto</span>
					
					<div class="d-flex">
						<img src="aaa.png" class="img-thumbnail col-1 align-self-start rounded-circle  m-1" alt="..." width="20%">

						<div class="col">
							<div class="p-2 rounded-3  border mt-2 ms-1   bg-secondary text-white position-relative">

							<svg width="1em" height="1em" viewBox="0 0 16 16" class="position-absolute top-0 start-0 translate-middle mt-1 bi bi-caret-down-fill" fill="#6c757d" xmlns="http://www.w3.org/2000/svg"><path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>

							Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
							tempor incididunt ut labore et dolore magna aliqua. Ut enim ad consequat. Duis aute irure dolor in reprehenderit in voluptate 

							</div>
							<span class="text-muted ">10:15</span>
					
						</div>
						



					</div>
					
				</div>

				<div class="col-10 mt-2 offset-2">
					
					<div class="d-flex ">
					
					<div class="p-2 col border rounded-3 bg-primary mt-2 me-1 position-relative text-white">
						<svg width="1em" height="1em" viewBox="0 0 16 16" class="position-absolute top-0 start-100 translate-middle mt-1 bi bi-caret-down-fill" fill="#0d6efd" xmlns="http://www.w3.org/2000/svg">
							<path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
						</svg>

						Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
						tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
						erit in voluptate 
					</div>
					<img src="aaa.png" class="img-thumbnail col-1 align-self-start rounded-circle  m-1" alt="..." width="20%">

				</div>
				<span class="text-muted">10:15</span>
					
				</div>


			-->	
			</div>

			<div class="modal-footer row " id="to">
				 
				<input type="text" name="msg" id="msg" class="form-control col ms-3" placeholder="Votre message"> 
				<button class="btn-sm btn  btn-white  col-2" type="submit" id="send">
						<svg xmlns="http://www.w3.org/2000/svg" width="45" height="25" fill="#45d055" class="bi bi-symmetry-horizontal" viewBox="0 0 16 16">
  						<path d="M13.5 7a.5.5 0 0 0 .24-.939l-11-6A.5.5 0 0 0 2 .5v6a.5.5 0 0 0 .5.5h11zm.485 2.376a.5.5 0 0 1-.246.563l-11 6A.5.5 0 0 1 2 15.5v-6a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 .485.376zM11.539 10H3v4.658L11.54 10z"/>
					</svg>
					
				</button>
				 
			</div>
		
			
			
		</div>
		
	</div>
	
</div>



<script>
/*let url = location.host == 'localhost' ?
  'ws://localhost:8080/ws' : location.host == 'javascript.local' ?
  `ws://javascript.local/article/websocket/chat/ws` : // dev integration with local site
  `wss://javascript.info/article/websocket/chat/ws`; // prod integration with javascript.info*/

//let url = "ws://dinyadchat.herokuapp.com";
let url = location.origin.replace(/^http/, 'ws');

//console.log(url);
//let url = location.host == 'localhost'?'ws://localhost:8080/ws':"ws://dinyadchat.herokuapp.com:8080/ws";
let socket = new WebSocket(url);


//Onopen

const onopen= function(event) {
	// body...
	yp.textContent="Connecté(e) en tant que "+user.value;
	yp.className="text-success";

}

//Onmessage
const onmessage = function(event) {
	let incomingMessage = JSON.parse(event.data);
  if(incomingMessage.id == autor){
  	encore = true;
  }
  else{
  	autor = incomingMessage.id;
  	encore = false;
  }

  if(firt){
  	const deft = document.getElementById("deft");
  	deft.remove();
  	firt=false;
  }
  if(incomingMessage.id==user.value){
  	showMessage(incomingMessage,"me");
  }
  else{
  	showMessage(incomingMessage,"lui");
  }

  scroller();
  
}


//Onclose
var onclose = function(event) {
	console.log(`Closed ${event.code}`);
	yp.textContent="Deconnecté(e)";
	yp.className="text-danger";

 yp.textContent="Reconnexion";
 yp.className="text-info";
	

	
  socket = new WebSocket(url);
	socket.addEventListener("open",onopen);
	socket.addEventListener("message",onmessage);
	socket.addEventListener("close",onclose);

	//yp.textContent="Reconnexion";
	
	

}


//Add Listener
socket.addEventListener("open",onopen);
socket.addEventListener("message",onmessage);
socket.addEventListener("close",onclose);

let encore = false;
let firt =true;
let autor = "123456789@$#123456789";

// send message from the form
var btn = document.getElementById("send");
var msg = document.getElementById("msg");
var user = document.getElementById("user");
var y = document.getElementById("you");
var yp = document.getElementById("youp");
user.onchange = function() {y.textContent=user.value; yp.textContent="Connecté(e) en tent que "+user.value;}
btn.onclick = function() {
	var dat = new Date();
	var h = dat.getHours();
	var min = dat.getMinutes();
	if(msg.value!=""){
  let outgoingMessage = msg.value;
  const data = JSON.stringify({url : "/chat" ,data : {id: user.value, msg : outgoingMessage ,date : h+":"+min}});
  socket.send(data);
  msg.value="";
}
  return false;
};
var h = 1000;
function scroller(){
	
	$("#cp").animate({
		scrollTop : h
	},1000,function(){

	});

	h=h+100;
}


// show message in div#messages
function showMessage(message,t) {
	
	var div = document.createElement('div');

	var divp = document.createElement('div');

	var divfp = document.createElement('div');

	var divf = document.createElement('div');

	var img = document.createElement('img');
	var img2 = document.createElement('div');

	var aut = document.createElement('span');
	var dt = document.createElement('span');



	var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
	var path = document.createElementNS("http://www.w3.org/2000/svg",'path');

	divf.textContent = message.msg;

	divfp.className="col";

	
	dt.textContent=message.date;

	img.className="img-thumbnail col-1 align-self-start rounded-circle  m-1";
	img2.className="col-1 m-1";
	img.alt="CM";
	img.width="20%";

	
	svg.setAttribute("width","1em");
	svg.setAttribute("height","1em");
	svg.setAttribute("viewBox","0 0 16 16");

	path.setAttribute("d","M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z")

	svg.append(path);
	

	if(t=="me"){
		
		div.className="mt-1 col-10 offset-2";
		dt.className="text-muted";
		divp.className ="d-flex ";
		divf.className ="p-2 col border rounded-3 bg-primary mt-1 me-1 position-relative text-white";
		img.src="bbb.jpeg";
		svg.setAttribute("fill","#0d6efd")
		
		svg.setAttribute("class","position-absolute top-0 start-100 translate-middle mt-1 bi bi-caret-down-fill");
		
		if(!encore){
			divf.append(svg);
		}
		divp.append(divf);
		if(!encore){
			divp.append(img);
		}
		else{
			divp.append(img2);
		}

		div.append(divp);
		div.append(dt);
	}
	else{
		aut.className="fw-bold";
	
		aut.textContent=message.id;
		div.className="mt-1 col-10";
		dt.className="text-muted";
		divp.className ="d-flex ";
		divf.className="p-2 rounded-3 border mt-1 ms-1   bg-secondary text-white position-relative";
		img.src="aaa.png";
		svg.setAttribute("fill","#6c757d")
		
		svg.setAttribute("class","position-absolute top-0 start-0 translate-middle mt-1 bi bi-caret-down-fill");

		if(!encore){
			div.append(aut);
			divf.append(svg);
		}
		
		
		if(!encore){
			divp.append(img);
		}
		else{
			divp.append(img2);
		}
		divfp.append(divf);
		divfp.append(dt);
		divp.append(divfp);
		div.append(divp);
		

	}
	
   
   








	/*let messageElem = document.createElement('div');
	if(t=="me"){
		messageElem.className="p-2 offset-2 card col-10  bg-primary text-white border border-rounded rounded";
	}

	else{
		messageElem.className="p-2  card col-10  bg-secondary text-white border border-rounded";
	}*/
  
  
   document.getElementById('cp').append(div);
}


setTimeout(()=>{
  socket.close();
},8000);
</script>

<script type="text/javascript" src="bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
</body>
</html>
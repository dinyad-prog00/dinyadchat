<!DOCTYPE html>
<html class="h-100">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="jquery.min.js"></script>

    
	<title>DinyadChat</title>

	
</head>
<body class="h-100">
	<div class="h-100 d-table w-100">
		<div class="align-middle  m-1 d-table-cell  text-center ">
		<h2>DinyadChat</h2>
		<h4 class="text-muted" id="salle">Salle Les Fans #12554445</h4>
		<div class="card col-md-4 offset-md-4 p-2">
		<div class="input-group">
			<label class="input-group-text">Pseudo</label>
			<input type="text" name="user" readonly="" id="user" class="form-control">
			
		</div><br>
		<button id="entrer" class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#mym">Commencer</button>
		</div>

		
		</div>
	</div>

	<div class="col-10 offset-1 col-md-4 offset-md-4 mt-5" style=" position:absolute;top:0;height:40px;" id="veux">
				<a id="jlcreer" class="text-decoration-none text-white mt-5">
					<button class="btn btn-secondary  btn-sm form-control">
							Je veux ma propre salle maintenant
					</button>
				</a>
		</div>	
  
	
  <!--
	
		<h4 class="card-title">Bien dans DinyadChat</h4>
		<a href="" data-bs-target="#toh" data-bs-toggle="collapse"> <span class="badge badge-white">Aide</span></a>
		
	
	<div class="card-body collapse show" id="toh">
		<div class="menu">
			<ul>
				<li class="menu-item">Entrez votre pseudo à utiliser dans le chat</li>
				<li class="menu-item">Cliquez sur Entrer</li>
				
			</ul>
			
		</div>
	</div>


-->






<div class="modal" id="mym" aria-hidden="true">
	<div class=" modal-dialog modal-fullscreen-sm-down  modal-dialog-scrollable">
		<div class="modal-content" id="content">
			<div class="modal-header bg-info bg-gradient text-white" >
				<div class="d-flex">
					<img src="aaa.png" class="img-thumbnail rounded-circle align-self-center m-1" alt="..." width="20%">
					<div class="m-1">
						
						<h4 class="modal-title ">Dinyad chat</h4>
						<span class="text-muted" id="youp">Vous en tant que <em id="you"></em></span>
					</div>
					

				</div>
			
			
				<div class="spinner-border text-secondary" role="status" id="spinner">
          	<span class="visually-hidden">Loading...</span>
        </div>
        <div id="logout">
        	<a title="Se deconnecter"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#ffffff" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
  					<path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
  					<path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
				</svg>
					</a>
        </div>

        <div id="login">
        	<a title="Se connecter"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#ffffff" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  					<path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  					<path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
  					</a>
</svg>
        </div>
				
			<button class="btn btn-close" data-bs-dismiss="modal"></button>
			</div>
		

	
			<div class="modal-body collapse show" id="cp">

				<div class="text-center" id="deft">
					<div class="m-2 p-2 pb-0 mb-0"><h4>Discuter instantanément avec vos amis à l'aide de DinyadChat</h4></div>
					
					<img src="disc.webp" class=" mx-auto d-block" alt="..." width="70%">

					
					<h6 id="venezdentrer">Vous venez d'entrer dans le chat, tapez votre message et envoyez.</h6>
					
				</div>
				<!--
				
				 <div class="mt-2 col-10">
				<span class="fw-bold">Dinyad Yeto</span>
					
					<div class="d-flex">
						<img src="aaa.png" class="img-thumbnail col-1 align-self-start rounded-circle  m-1" alt="..." width="20%">

						<div class="col">
							<div class="p-2 rounded-3  border mt-2 ms-1   bg-secondary text-white position-relative">

								<div class="p-1  border-start border-white border-5 o mb-1 rounded-3  " style="background-color: #8c8b94;">
									<a href="#deft" class="text-decoration-none text-white" ><span class="text-dark">Dinyad</span><br>Ceci est une reférence à un message Ceci est une reférence à un message ... </a>
								</div>

							<svg width="1em" height="1em" viewBox="0 0 16 16" class="position-absolute top-0 start-0 translate-middle mt-1 bi bi-caret-down-fill" fill="#6c757d" xmlns="http://www.w3.org/2000/svg"><path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>

							Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
							tempor incididunt ut labore et dolore magna aliqua. Ut enim ad consequat. Duis aute irure dolor in reprehenderit in voluptate 

							</div>
							<span class="text-muted ">10:15</span>
					
						</div>
						



					</div>
					
				</div>

				<div class="col-10 mt-2 offset-2">
					
					<div class="d-flex ">
					
					<div class="p-2 col border rounded-3 bg-primary mt-2 me-1 position-relative text-white">

						<div class="p-1  border-start border-white  border-5 o mb-1 rounded-3  " style="background-color: #6a5aeb;">
								<a href="#deft" class="text-decoration-none text-white" ><span class="text-dark">Vous</span><br>Ceci est une reférence à un message Ceci est une reférence à un message ... </a>
						</div>


						<svg width="1em" height="1em" viewBox="0 0 16 16" class="position-absolute top-0 start-100 translate-middle mt-1 bi bi-caret-down-fill" fill="#0d6efd" xmlns="http://www.w3.org/2000/svg">
							<path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
						</svg>

						Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
						tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
						erit in voluptate 
					</div>
					<img src="aaa.png" class="img-thumbnail col-1 align-self-start rounded-circle  m-1" alt="..." width="20%">

				</div>
				<span class="text-muted">10:15</span>
					
				</div>


			-->
			</div >

			<div id="refdiv">
				
			</div>
			<!--
			<img class="rounded mx-auto d-block img-thumbnail" src="#" alt="" id="image" style="max-width: 200px; margin-top: 20px;" >
		  -->
			

			<div class="modal-footer row " id="to">

				 
				
					<input type="text" name="msg" id="msg" class="form-control col ms-3" placeholder="Votre message"> 

					<!--
					<form class="col-2" method="post" url="/upload-picture" enctype="multipart/form-data" accept=".jpg, .png, .gif, .jpeg, .webp">

    				<input type="file" name="picture" onchange="previewPicture(this)" required >

					</form>
				-->


					<button class="btn-sm btn  btn-white  col-2" type="submit" id="send">
							<svg xmlns="http://www.w3.org/2000/svg" width="45" height="25" fill="#45d055" class="bi bi-symmetry-horizontal" viewBox="0 0 16 16">
	  						<path d="M13.5 7a.5.5 0 0 0 .24-.939l-11-6A.5.5 0 0 0 2 .5v6a.5.5 0 0 0 .5.5h11zm.485 2.376a.5.5 0 0 1-.246.563l-11 6A.5.5 0 0 1 2 15.5v-6a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 .485.376zM11.539 10H3v4.658L11.54 10z"/>
						</svg>
					
				</button>
				
				 
			</div>
		
			
			
		</div>
		
	</div>
	
</div>

<div class="col-6 offset-3 col-md-4 offset-md-4 mt-4" id="creer">
	<a id="lcreer" href="vv" class=" text-white"><button class="btn btn-primary  form-control">
	Créer
</button></a>
</div>


<script>

	function jveux() {
		$("#veux").hide();
		setTimeout(()=>{
			$("#veux").show();
			setTimeout(()=>{
				jveux();
			},5000)
		},3000)
	}

	jveux();

	$("#logout").hide();
	$("#login").hide();
/*let url = location.host == 'localhost' ?
  'ws://localhost:8080/ws' : location.host == 'javascript.local' ?
  `ws://javascript.local/article/websocket/chat/ws` : // dev integration with local site
  `wss://javascript.info/article/websocket/chat/ws`; // prod integration with javascript.info*/

//let url = "ws://dinyadchat.herokuapp.com";
let url = location.origin.replace(/^http/, 'ws')+location.pathname;

//alert();
//let url = location.host == 'localhost'?'ws://localhost:8080/ws':"ws://dinyadchat.herokuapp.com:8080/ws";
let socket = new WebSocket(url);


var recnt=true;
function froom(url) {
  return url.substr(3,8);
}

function fuser(url) {
  return url.substr(19,url.length);
}
//Onopen

var salle = document.getElementById("salle");

salle.textContent="Salle #"+froom(location.pathname);

const onopen= function(event) {
	// body...
	yp.textContent="Connecté(e), "+user.value;
	yp.className="text-success";
	$("#spinner").hide();
	$("#login").hide();
	$("#logout").show();

}


var lcreer = document.getElementById("lcreer");
var jlcreer = document.getElementById("jlcreer");
var creer= document.getElementById("creer");

lcreer.href=location.origin;
jlcreer.href=location.origin;
//alert(lcreer.href);

//Onmessage
const onmessage = function(event) {
	let incomingMessage = JSON.parse(event.data);
	//alert(incomingMessage.url);
	if(incomingMessage.url=="/newuser"){
     printuser(incomingMessage.name);
	}
	else if(incomingMessage.url=="/quit"){
     printquit(incomingMessage.name);
	}

	else if(incomingMessage.url=="/notfound"){
    showMessage(incomingMessage,"lui");
    recnt=false;
    socket.close();
    document.getElementById('cp').append(creer);
    $("#venezdentrer").hide();
	}
	else{
	  if(incomingMessage.id == autor){
	  	encore = true;
	  }
	  else{
	  	autor = incomingMessage.id;
	  	encore = false;
	  }

	  if(firt){
	  	const deft = document.getElementById("deft");
	  	deft.remove();
	  	firt=false;
	  }
	  if(incomingMessage.id==user.value){
	  	showMessage(incomingMessage,"me");
	  }
	  else{
	  	showMessage(incomingMessage,"lui");
	  }
	}

  scroller();
  
}


//Onclose
var onclose = function(event) {
	console.log(`Closed ${event.code}`);
	yp.textContent="Deconnecté(e)";
	yp.className="text-danger";
	$("#logout").hide();



	if(recnt){
	$("#login").hide();
  yp.textContent="Reconnexion";
  yp.className="text-white";
  $("#spinner").show();
	

	
  socket = new WebSocket(url);
	socket.addEventListener("open",onopen);
	socket.addEventListener("message",onmessage);
	socket.addEventListener("close",onclose);
}

	//yp.textContent="Reconnexion";
	
	

}


//Add Listener
socket.addEventListener("open",onopen);
socket.addEventListener("message",onmessage);
socket.addEventListener("close",onclose);





let encore = false;
let firt =true;
let autor = "123456789@$#123456789";

// send message from the form
var btn = document.getElementById("send");
var msg = document.getElementById("msg");
var user = document.getElementById("user");
var y = document.getElementById("you");
var yp = document.getElementById("youp");
var mym = document.getElementById("mym");

//Referencement
var refdefined=false;
var refmsg="";
var refhref="";
var refuser="";

user.value=fuser(location.pathname);
function deux(a) {
  if(a.length == 1)
    return "0"+a;
  else
    return a;
}
user.onchange = function() {y.textContent=user.value; yp.textContent="Connecté(e) en tent que "+user.value;}
btn.onclick = function() {
	var dat = new Date();
	var h = dat.getHours();
	var min = dat.getMinutes();

	if(msg.value!=""){
  let outgoingMessage = msg.value;
  var tosend = {
  	url : "/chat" ,
  	data : {
  		id: user.value,
  		msg : outgoingMessage,
  		date : deux(h+"")+":"+deux(min+""),
  		room : froom(location.pathname)
  		}
  };

  if(refdefined){
  	tosend.data.ref={msg : refmsg, user : refuser, href : "#"+refhref };
  	refdefined=false;
  	document.getElementById('refdiv').innerHTML="";
  }

  const data = JSON.stringify(tosend);
  socket.send(data);
  msg.value="";
}
  return false;
};
var h = 1000;
function scroller(){
	
	$("#cp").animate({
		scrollTop : h
	},1000,function(){

	});

	h=h+100;
}

function printuser(n) {
	var div =  document.createElement('div');
	div.className="card border border-secondary text-center col-10 offset-1 rounded-3 bg-light text-break text-muted  p-1 mt-2";
	div.textContent=n+" vient d'entrer dans le chat";
	document.getElementById('cp').append(div);
}

function printquit(n) {
	var div =  document.createElement('div');
	div.className="card border text-break border-warning text-center col-10 offset-1 rounded-3 bg-light text-muted  p-1 mt-2";
	div.textContent=n+" vient de quitter le chat";
	document.getElementById('cp').append(div);
}

// show message in div#messages
var ids = 1;
function showMessage(message,t) {
	
	var div = document.createElement('div');

	var divp = document.createElement('div');

	var divfp = document.createElement('div');

	var divf = document.createElement('div');

	var ref = document.createElement('div');
	var refa = document.createElement('a');
	//var refspan = document.createElement('span');
	//var refbr = document.createElement('br');

	var img = document.createElement('img');
	var img2 = document.createElement('div');

	var aut = document.createElement('span');
	var dt = document.createElement('span');



	var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
	var path = document.createElementNS("http://www.w3.org/2000/svg",'path');

	divf.textContent = message.msg;
	divf.id = message.tag;

	divf.ondblclick = function(event){

		if(message.msg.length <100)
			refmsg=message.msg;
		else
			refmsg=message.msg.substr(0,100)+" ...";
		refuser=message.id;
		refhref=message.tag;
		refdefined=true;
		if(refuser == user.value)
			makeref("Vous",refmsg,refhref);
		else
			makeref(refuser,refmsg,refhref);
		document.getElementById('msg').focus();
	}	
	


	divfp.className="col";


	
	dt.textContent=message.date;

	img.className="img-thumbnail col-1 align-self-start rounded-circle  m-1";
	img2.className="col-1 m-1";
	img.alt="CM";
	img.width="20%";

	
	svg.setAttribute("width","1em");
	svg.setAttribute("height","1em");
	svg.setAttribute("viewBox","0 0 16 16");

	path.setAttribute("d","M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z")

	svg.append(path);

	if(message.ref){
		
		refa.href=message.ref.href;
		refa.className="text-decoration-none text-white";
		refa.innerHTML='<span class="text-dark">'+(message.ref.user==user.value?"Vous":message.ref.user)+'</span><br>'+message.ref.msg;
		ref.append(refa);
		divf.prepend(ref);

		var tag=message.ref.href.substr(1,message.ref.href.length-1);

			ref.onclick=function(event) {

				//event.preventDefault();   
				//event.stopPropagation();
				document.getElementById(tag).className="p-2 col border rounded-3 bg-info mt-1 me-1 position-relative text-white"
			setTimeout(()=>{
				
				if(message.ref.user==user.value){

				document.getElementById(tag).className="p-2 col border rounded-3 bg-primary mt-1 me-1 position-relative text-white";
				}
				else{
					document.getElementById(tag).className="p-2 rounded-3 border mt-1 ms-1   bg-secondary text-white position-relative";
				}
			},4000);

			}
 
  }
	

	if(t=="me"){
		
		div.className="mt-1 col-10 offset-2";
		dt.className="text-muted";
		divp.className ="d-flex ";
		divf.className ="p-2 col border rounded-3 bg-primary mt-1 me-1 position-relative text-white text-break";
		ref.className ="p-1  border-start border-white  border-5 o mb-1 rounded-3 ";
		img.src="bbb.jpeg";
		ref.style.backgroundColor = "#6a5aeb";
		svg.setAttribute("fill","#0d6efd")
		
		svg.setAttribute("class","position-absolute top-0 start-100 translate-middle mt-1 bi bi-caret-down-fill");
		
		if(!encore){
			divf.append(svg);
		}
		divp.append(divf);
		if(!encore){
			divp.append(img);
		}
		else{
			divp.append(img2);
		}

		div.append(divp);
		div.append(dt);
	}
	else{
		aut.className="fw-bold";
	
		aut.textContent=message.id;
		div.className="mt-1 col-10";
		dt.className="text-muted";
		divp.className ="d-flex ";
		divf.className="p-2 rounded-3 text-break border mt-1 ms-1   bg-secondary text-white position-relative";
		ref.className="p-1  border-start border-white border-5 o mb-1 rounded-3 ";
		ref.style.backgroundColor = "#8c8b94";
		img.src="aaa.png";
		svg.setAttribute("fill","#6c757d")
		
		svg.setAttribute("class","position-absolute top-0 start-0 translate-middle mt-1 bi bi-caret-down-fill");

		if(!encore){
			div.append(aut);
			divf.append(svg);
		}
		
		
		if(!encore){
			divp.append(img);
		}
		else{
			divp.append(img2);
		}
		divfp.append(divf);
		divfp.append(dt);
		divp.append(divfp);
		div.append(divp);
		

	}
	
   

  
   document.getElementById('cp').append(div);
}


function makeref(user,msg,id){
	var div = document.createElement('div');
	div.innerHTML='<div class="p-1 me-5 border-start border-dark position-relative  border-5 ms-3 mb-1 rounded-3  " style="background-color: #6a5aeb;"><button id="refclose" class="btn btn-close position-absolute start-100 top-0 btn-sm"></button><a class="text-decoration-none text-white" ><span class="text-dark">'+user+'</span><br>'+msg+'</a></div>';
	document.getElementById('refdiv').innerHTML="";
	document.getElementById('refdiv').append(div);
	
	$("#refclose").click(()=>{
		document.getElementById('refdiv').innerHTML="";
		refdefined=false;
	})
}

//makeref("Yeto","Salut lesgars");


$("#logout").click((event)=>{
	recnt=false;
	socket.close();
	$("#logout").hide();
	$("#login").show();

});

$("#login").click((event)=>{
	recnt=true;
	onclose(event);
});
	


////previsualiser image
var image = document.getElementById("image");
     
    // La fonction previewPicture
    var previewPicture  = function (e) {

        // e.files contient un objet FileList
        const [picture] = e.files

        // Les types de fichier autorisés
    	var types = [ "image/jpg", "image/gif","image/webp", "image/jpeg", "image/png" ];

        // "picture" est un objet File
        if (picture && types.includes(picture.type)) {
            // On change l'URL de l'image
            image.src = URL.createObjectURL(picture)
        }
        else{
        	alert("C'est pas une image");
        	image.src ="";
        }
    } 
</script>

<script type="text/javascript" src="bootstrap.bundle.min.js"></script>
</body>
</html>